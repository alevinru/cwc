import lo from 'lodash';
import log from 'sistemium-telegram/services/log';

const { error } = log('ruBattle');

const CASTLES = new Map([
  ['๐ขะขะพัััะณะธ', 't'],
  ['โ๏ธะะฟะปะพัะฐ', 'o'],
  ['๐นะะฐััะฒะตัะฐ', 'r'],
  ['๐ะะผะฑะตัะฐ', 'a'],
  ['๐ฆะะพัะธ', 'n'],
  ['๐คะกะบะฐะปั', 's'],
  ['๐ะคะตัะผั', 'f'],
]);

const CASTLE_ICONS = ['๐ข', 'โ๏ธ', '๐น', '๐', '๐ฆ', '๐ค', '๐'];

const DIFF_MAP = new Map([
  ['ัะบััะฐะปะธ, ะฝะฐ ะฝะธั ะฝะธะบัะพ ะฝะต ะฝะฐะฟะฐะป', null],
  ['ะปะตะณะบะพ ะพัะฑะธะปะธัั', 0],
  ['ะทะฝะฐัะธัะตะปัะฝัะผ ะฟัะตะธะผััะตััะฒะพะผ', 0],
  ['ััะฟะตัะฝะพ ะฐัะฐะบะพะฒะฐะปะธ', 1],
  ['ััะฟะตัะฝะพ ะพัะฑะธะปะธัั', 1],
  ['ัะธะปั ะฑัะปะธ ะฟะพััะธ ัะฐะฒะฝั', 2],
  ['ะฝะฐััะพััะฐั ะฑะพะนะฝั', 2],
]);

const IS_BATTLE_RE = /ะะตะทัะปััะฐัั ััะฐะถะตะฝะธะน/;

const MAINLINE_RE = /(๐ฑ)?(๐ก|โ) ([^\n]+)/;
const ATK_LINE_RE = /๐ะะธะดะตัั ะฐัะฐะบะธ: ([^\n]+)/;
const DEF_LINE_RE = /๐ะะธะดะตัั ะทะฐัะธัั: ([^\n]+)/;
const GOLD_LINE_RE = /๐(ะฃ ะฐัะฐะบัััะธั|ะัะฐะบัััะธะต).+ (\d+) ะทะพะปะพััั ะผะพะฝะตั/;
const STOCK_LINE_RE = /๐(ะฃ ะฐัะฐะบัััะธั|ะัะฐะบัััะธะต).+ (\d+) ัะบะปะฐะดัะบะธั ััะตะตะบ/;

const POINTS_START_RE = /ะะพ ะธัะพะณะฐะผ ััะฐะถะตะฝะธะน ะทะฐะผะบะฐะผ ะฝะฐัะธัะปะตะฝะพ/;

export default function (text) {

  const parts = text.split('\n\n');

  const results = [];

  const pointsText = lo.find(parts, p => POINTS_START_RE.test(p));

  const scores = scoresHash(pointsText || '');

  CASTLES.forEach((code, key) => {

    const part = lo.find(parts, partText => {
      return partText.match(RegExp(`(ั ะฒะพัะพั|ะะฐัะธัะฝะธะบะธ) ${key}`));
    });

    if (!part) {
      return;
    }

    const [, gaIcon, statusIcon, resLine] = part.match(MAINLINE_RE) || [];

    const [, atkLine] = part.match(ATK_LINE_RE) || [];
    const [, defLine] = part.match(DEF_LINE_RE) || [];
    const [, goldType, goldText] = part.match(GOLD_LINE_RE) || [];
    const [, , stockText] = part.match(STOCK_LINE_RE) || [];

    if (!resLine) {
      error(code, text);
      throw Error('Not matched battle mainline');
    }

    const castle = key.match(/[^ะฐ-ั]+/i)[0];

    results.push({
      castle,
      code,
      result: battleResult(statusIcon),
      difficulty: battleDifficulty(resLine),
      ga: !!gaIcon,
      gold: battleGold(goldType, goldText),
      stock: battleGold(goldType, stockText),
      score: scores[castle],
      atkLeaders: battleLeaders(lo.trim(atkLine)),
      defLeaders: battleLeaders(lo.trim(defLine)),
    });

  });

  return {
    results,
    text,
  };

}

export function battleText(message) {
  const text = lo.get(message, 'last_message.content.text.text');
  return IS_BATTLE_RE.test(text) && text;
}

function scoresHash(text) {

  return lo.mapValues(lo.keyBy(CASTLE_ICONS), castle => {
    const re = RegExp(`${castle}.+ [+](\\d+) ๐ ะพัะบะพะฒ`);
    const [, points] = text.match(re) || [];
    return parseInt(points, 0) || 0;
  });

}

function battleLeaders(text) {
  if (!text) {
    return [];
  }
  return text.split(RegExp(` (?=${CASTLE_ICONS.join('|')})`));
}

function battleGold(type, text) {
  if (!text) {
    return 0;
  }
  return parseInt(text, 0) * (type === 'ะัะฐะบัััะธะต' ? -1 : 1);
}

function battleResult(icon) {
  switch (icon) {
    case 'โ':
      return 'breached';
    case '๐ฑ๐ก':
    case '๐ก':
      return 'protected';
    default:
      throw Error(`Unexpected battleResult icon ${icon}`);
  }
}

function battleDifficulty(text) {
  const found = lo.find(Array.from(DIFF_MAP.keys()), key => text.match(RegExp(key)));
  if (!found) {
    error('battleDifficulty', text);
    throw Error('Not found battle difficulty');
  }
  return found ? DIFF_MAP.get(found) : null;
}

/*
14 Lenzin 1064
ะะตะทัะปััะฐัั ััะฐะถะตะฝะธะน:
๐ก ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐ขะขะพัััะณะธ ะทะฐัะธัะฝะธะบะธ ะปะตะณะบะพ ะพัะฑะธะปะธัั ะพั ะถะฐะปะบะพะน ะณะพัััะบะธ ะฒะพะธะฝะพะฒ ๐ะคะตัะผั.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐Mathew ๐ค[NL]tahir_go
๐ะะธะดะตัั ะทะฐัะธัั: ๐ข[TEA]ะัะณะตัั ะขะก3ะ ๐ข[RUะ]Alkin ๐ข[BBS]MiniSatana ๐ข[PYN]ะะพะปะพั ัะฒััะต
๐ะฃ ะฐัะฐะบัััะธั ะพัะพะฑัะฐะปะธ 13 ะทะพะปะพััั ะผะพะฝะตั.

โ๏ธ ะ ะฑะธัะฒะต ั ะฒะพัะพั โ๏ธะะฟะปะพัะฐ ะฒะพะธะฝั  ๐คะกะบะฐะปั ๐ขะขะพัััะณะธ ๐ฆะะพัะธ ๐นะะฐััะฒะตัะฐ ๐ะคะตัะผั
    ััะฟะตัะฝะพ ะฐัะฐะบะพะฒะฐะปะธ ะทะฐัะธัะฝะธะบะพะฒ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ข[13G]BorovkovEA ๐ข[WCH]ะฅัะฐะฝะธัะตะปั ะบะพััั ๐ข[ะะจ]eto je val ๐ข[OCE]Atomic
๐ะะธะดะตัั ะทะฐัะธัั: โ๏ธ[ะะะ]ะฅัะฐะฝะธัะตะปั ะะฟะปะพัะฐ โ๏ธ[ะะะ]ะ ะะะงะะะฌ โ๏ธ[TWR]pchelka โ๏ธ[ะะะ]ะฉะธั ะะฟะปะพัะฐ
๐ะัะฐะบัััะธะต ัะฐะทะณัะฐะฑะธะปะธ ะทะฐะผะพะบ ะฝะฐ 9891 ะทะพะปะพััั ะผะพะฝะตั, ะฟะพัะตััะฝะพ 14706 ัะบะปะฐะดัะบะธั ััะตะตะบ.

๐ก ะะฐัะธัะฝะธะบะธ ๐นะะฐััะฒะตัะฐ ัะบััะฐะปะธ, ะฝะฐ ะฝะธั ะฝะธะบัะพ ะฝะต ะฝะฐะฟะฐะป.

๐ก ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐ะะผะฑะตัะฐ ะทะฐัะธัะฝะธะบะธ ะปะตะณะบะพ ะพัะฑะธะปะธัั ะพั ะถะฐะปะบะพะน ะณะพัััะบะธ ะฒะพะธะฝะพะฒ
    ๐นะะฐััะฒะตัะฐ,๐ะคะตัะผั &๐คะกะบะฐะปั.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐น[LVT]OderRodion ๐Canadian feller ๐ค[KYS]SCIENTIST ๐ฆ[ALC]ะขััะฝั
๐ะะธะดะตัั ะทะฐัะธัั: ๐[7DS]mIRA ๐[9KA]su4ara 9KA ๐[YLT]Fortunate son ๐[7DS]Acedia
๐ะฃ ะฐัะฐะบัััะธั ะพัะพะฑัะฐะปะธ 88 ะทะพะปะพััั ะผะพะฝะตั.

โ๏ธ ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐ฆะะพัะธ ะฒะพะธะฝั  ๐ขะขะพัััะณะธ ๐ะคะตัะผั ๐ะะผะฑะตัะฐ ๐นะะฐััะฒะตัะฐ โ๏ธะะฟะปะพัะฐ
    ััะฟะตัะฝะพ ะฐัะฐะบะพะฒะฐะปะธ ะทะฐัะธัะฝะธะบะพะฒ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ข[JR]ะจะฐัะฐัะตะปั ะกะบะฐะปั ๐ข[DTF]ArtemisEntrery ๐[RZD]47th ๐[TND]ะะฐะทััะปะธะฒะฐะตั
๐ะะธะดะตัั ะทะฐัะธัั: ๐ฆ[DS]Sir Lancelot ๐ฆ[NTR]Suworow ๐ฆ[AFS]teffsy ๐ฆ[DS]Crosby15
๐ะัะฐะบัััะธะต ัะฐะทะณัะฐะฑะธะปะธ ะทะฐะผะพะบ ะฝะฐ 9676 ะทะพะปะพััั ะผะพะฝะตั, ะฟะพัะตััะฝะพ 22307 ัะบะปะฐะดัะบะธั ััะตะตะบ.

๐ก ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐คะกะบะฐะปั ะทะฐัะธัะฝะธะบะธ ะปะตะณะบะพ ะพัะฑะธะปะธัั ะพั ะถะฐะปะบะพะน ะณะพัััะบะธ ะฒะพะธะฝะพะฒ
    ๐ฆะะพัะธ,๐นะะฐััะฒะตัะฐ &๐ะะผะฑะตัะฐ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐[A1]Nihilias ๐[WH]CruorVultTigeron ๐ฆRock Master ๐นInvisigod
๐ะะธะดะตัั ะทะฐัะธัั: ๐ค[TS]Poherantos ๐ค[KVA]ะะะขะะะะขะะ ๐ค[IRN]Sanktym ๐ค[ARR]abubaca4
๐ะฃ ะฐัะฐะบัััะธั ะพัะพะฑัะฐะปะธ 191 ะทะพะปะพััั ะผะพะฝะตั.

โ๏ธ ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐ะคะตัะผั ะฒะพะธะฝั โ๏ธะะฟะปะพัะฐ,๐คะกะบะฐะปั &๐ฆะะพัะธ ััะฟะตัะฝะพ ะฐัะฐะบะพะฒะฐะปะธ ะทะฐัะธัะฝะธะบะพะฒ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ค[SS]๐AndreGod ๐ค[NMR]Fishboss ๐ฆ[TNT]Flame4 ๐ค[KSS]all4u
๐ะะธะดะตัั ะทะฐัะธัั: ๐[MLT]pelmenka ๐[ะGG]IS A TRAP ๐[ASS]ะัะดั ะกััะฟะฐ ๐[2CH]ะณะพะปะพั ะพะฒะพัะตะน
๐ะัะฐะบัััะธะต ัะฐะทะณัะฐะฑะธะปะธ ะทะฐะผะพะบ ะฝะฐ 10684 ะทะพะปะพััั ะผะพะฝะตั, ะฟะพัะตััะฝะพ 17382 ัะบะปะฐะดัะบะธั ััะตะตะบ.

ะะพ ะธัะพะณะฐะผ ััะฐะถะตะฝะธะน ะทะฐะผะบะฐะผ ะฝะฐัะธัะปะตะฝะพ:
๐ขะขะพัััะณะฐ +64 ๐ ะพัะบะพะฒ
๐คะกะบะฐะปะฐ +50 ๐ ะพัะบะพะฒ
๐ะะผะฑะตั +26 ๐ ะพัะบะพะฒ
๐นะะฐะผะพะบ ะะฐััะฒะตัะฐ +20 ๐ ะพัะบะพะฒ
๐ฆะะพัะฝะพะน ะะฐะผะพะบ +7 ๐ ะพัะบะพะฒ
โ๏ธะะฟะปะพั +4 ๐ ะพัะบะพะฒ
๐ะคะตัะผะฐ +4 ๐ ะพัะบะพะฒ
 */

/*
๐ฑ๐ก ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐ะะผะฑะตัะฐ ัะธะปั ะฑัะปะธ ะฟะพััะธ ัะฐะฒะฝั, ะฝะพ ะทะฐัะธัะฝะธะบะธ ะณะตัะพะธัะตัะบะธ ะพััะฐะทะธะปะธ
    ะฐัะฐะบั ะฒะพะธะฝะพะฒโ๏ธะะฟะปะพัะฐ,๐ฆะะพัะธ &๐คะกะบะฐะปั.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ค[SS]๐AndreGod โ๏ธ[OWL]Kaffka ๐ค[KSS]all4u ๐ฆ[TNT]Flame4
๐ะะธะดะตัั ะทะฐัะธัั: ๐[ะะะ]Grozoth ๐[7DS]mIRA ๐[YLT]Fortunate son ๐[AT]ะะปะพะฑะฝัะน ะัะพะปั
๐ะฃ ะฐัะฐะบัััะธั ะพัะพะฑัะฐะปะธ 3308 ะทะพะปะพััั ะผะพะฝะตั.

โ๏ธ ะ ะฑะธัะฒะต ั ะฒะพัะพั ๐คะกะบะฐะปั ัะพ ะทะฝะฐัะธัะตะปัะฝัะผ ะฟัะตะธะผััะตััะฒะพะผ ะฒะพะธะฝั ๐นะะฐััะฒะตัะฐ,๐ะคะตัะผั &๐ขะขะพัััะณะธ
    ััะฟะตัะฝะพ ะฐัะฐะบะพะฒะฐะปะธ ะทะฐัะธัะฝะธะบะพะฒ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ข[JR]ะจะฐัะฐัะตะปั ะกะบะฐะปั ๐ข[ะะจ]eto je val ๐[TND]re_dragone ๐[ELF]Serterro
๐ะะธะดะตัั ะทะฐัะธัั: ๐ค[IRN]Sanktym ๐ค[DPS]Apko ๐ค[GOD]A I D ๐ค[ASF]kentmentoll
๐ะัะฐะบัััะธะต ัะฐะทะณัะฐะฑะธะปะธ ะทะฐะผะพะบ ะฝะฐ 10873 ะทะพะปะพััั ะผะพะฝะตั, ะฟะพัะตััะฝะพ 21320 ัะบะปะฐะดัะบะธั ััะตะตะบ.

โ๏ธ ะ ะฑะธัะฒะต ั ะฒะพัะพั โ๏ธะะฟะปะพัะฐ ัะฐะทัะณัะฐะปะฐัั ะฝะฐััะพััะฐั ะฑะพะนะฝั, ะฝะพ ะฒัะต-ัะฐะบะธ
    ัะธะปั ะฐัะฐะบัััะธั ะฑัะปะธ ัััั ัะธะปัะฝะตะต ะธ ๐นะะฐััะฒะตัะฐ,๐ะคะตัะผั,๐คะกะบะฐะปั &๐ขะขะพัััะณะธ ะฟะพะฑะตะดะธะปะธ.
๐ะะธะดะตัั ะฐัะฐะบะธ: ๐ข[13G]StyuAtt ๐ค[ะะะ]7ckingSad ๐ข[OCE]Atomic ๐ค[S2D]aLisa
๐ะะธะดะตัั ะทะฐัะธัั: โ๏ธ[TWR]KovalskyII โ๏ธ[ะะะ]ะตะธะฝะพะฒะฐั ะะฐะฝะดะฐ โ๏ธ[VTG]silentbobb โ๏ธ[DD]Dmytrukha
๐ะัะฐะบัััะธะต ัะฐะทะณัะฐะฑะธะปะธ ะทะฐะผะพะบ ะฝะฐ 9567 ะทะพะปะพััั ะผะพะฝะตั, ะฟะพัะตััะฝะพ 15520 ัะบะปะฐะดัะบะธั ััะตะตะบ.

๐ก ะะฐัะธัะฝะธะบะธ ๐ขะขะพัััะณะธ ััะฟะตัะฝะพ ะพัะฑะธะปะธัั ะพั ะฒะพะธะฝะพะฒ ๐ฆะะพัะธ,โ๏ธะะฟะปะพัะฐ &๐ะะผะฑะตัะฐ
๐ะะธะดะตัั ะฐัะฐะบะธ: โ๏ธ[OWL]Kaffka ๐ฆ[DS]DarthTonny ๐ฆ[WTF]Mars RRW ๐ฆ[TNT]ะะตัะฐะปัั ะธะท SOD
๐ะะธะดะตัั ะทะฐัะธัั: ๐ข[ะะ]Dark Eagle ๐ข[RW]Thanquol ๐ข[LA]DA Dance ๐ข[KOT]Letka
๐ะฃ ะฐัะฐะบัััะธั ะพัะพะฑัะฐะปะธ 13557 ะทะพะปะพััั ะผะพะฝะตั.

 */
